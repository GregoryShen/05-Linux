# 第二十二章 软件安装 RPM，SRPM 与 YUM

> 虽然使用原始码进行软件编译可以具有定制化的设置，但对于Linux distribution 的发布商来说，则有软件管理不易的问题，毕竟不是每个人都会进行原始码编译的。如果能够将软件预先在相同的硬件和操作系统上编译好再发布的话，就能够让相同的distribution具有完全一致的版本了。如果再加上简易的安装、删除、管理等机制的话，对于软件管理就会简单的多。

## 软件管理员简介

以原始码的方式来安装软件，也就是利用厂商放出来的Tarball 来进行软件的安装，每次安装软件都需要检测操作系统与环境、设置编译参数、实际的编译、最后还要根据个人喜好来安装软件到路径。

厂商可以先在他们的系统上编译出来可执行文件，然后将这个编译好的可执行文件直接放出来给使用者安装。

如果在安装的时候还可以加上一些跟这些程序相关的信息，将它建立称为数据库，就可以进行安装、反安装、升级和验证等等的相关功能。

在Linux上面至少就有两种的这方面的软件管理，分别是RPM 和 Debian的dpkg。CentOS 主要以RPM 为主。

### Linux 界的两大主流： RPM和 DPKG

Linux 开发商现在固定的硬件平台和操作系统平台上将需要安装或升级的软件编译好，然后将这个软件的所有相关文件打包成为一个特殊格式的文件，在这个文件内还包含了预先检测系统和依赖软件的脚本，并提供记录该软件提供的所有文件信息等。

用户端取得这个文件后，只要通过特定的指令来安装，那么该软件就会按照内部的脚本来检测依赖的软件是否存在，如果安装环境符合要求，就会开始安装。

目前Linux软件安装方式最常见的有两种，分别是：

* dpkg：

	这个机制最早是由Debian Linux 社区所开发出来的，通过dpkg 机制，Debian提供的软件就能够简单的安装起来，同时还能提供安装后的软件信息。只要是衍生于Debian的其他Linux distributions 大多使用dpkg 这个机制来管理软件的，包括B2D, Ubuntu 等等。

* RPM：

	这个机制最早是由Red Hat 这家公司开发出来的，因此很多distributions 就使用这个机制来作为软件安装的管理方式。 包括Fedora, CentOS, SuSE 等都是用这个。

不论 dpkg/rpm 这些机制或多或少都会有软件属性依赖的问题， 那该如何解决呢？ 如果我们将依赖属性的数据做成列表，等到实际软件安装时，如果发生有依赖属性的情况，例如安装A需要先安装B和C，而安装B则需要先安装D和E，那么当你安装A，通过属性依赖表，管理机制自动去获取B C D E来同时安装，就解决了属性依赖的问题。

目前新的Linux 开发商都有提供这样的“线上升级”机制，通过这个机制，原版光盘就只有第一次安装时需要用到而已，其他时候只要有网络，你就能够取得原本开发商所提供的任何软件。在dpkg 管理机制上就开发出APT的线上升级机制，RPM则根据开发商的不同，有RedHat的yum，SuSE的Yast Online Update(YOU)等。

| distribution 代表 | 软件管理机制 |   使用指令    | 线上升级机制（指令） |
| :---------------: | :----------: | :-----------: | :------------------: |
|  Red Hat/Fedora   |     RPM      | rpm, rpmbuild |       YUM(yum)       |
|   Debian/Ubuntu   |     DPKG     |     dpkg      |     APT(apt-get)     |



### 什么是RPM 和 SRPM

RPM 全名是 “RedHat Package Manager”。RPM 是一种数据库记录的方式来将你所需要的软件安装到你的Linux系统的一套管理机制。

当安装在你的Linux 主机时，RPM 会先依照软件里的数据查询Linux 主机的依赖属性软件是否满足，安装的时候就将该软件的信息整个写入RPM 的数据库中，以便将来的查询、验证和反安装。这样的优点是：

1. 由于已经编译完成并打包完毕，所以软件传输和安装上很方便（不需要再重新编译）
2. 由于软件的信息都已经记录在Linux 主机的数据库上，很方便查询、升级和反安装

缺点就是RPM文件里的内容都已经编译完成，所以，该软件文件几乎只能安装在原本默认的硬件和操作系统版本中。通常不同的distribution 所放出的RPM文件，不能互用。

这些软件管理机制的问题是：

1. 软件文件安装的环境必须和打包时的环境需求一致或相当
2. 需要满足软件的依赖属性需求
3. 反安装时需要特别小心，最底层的软件不能先移除，否则可能造成整个系统的问题

如果想安装其他distributions 提供的RPM软件时，可以用SRPM，SRPM= Source RPM，也就是这个RPM文件内有源代码。也就是这个SRPM 所以提供的软件内容并没有经过编译，它提供的是源代码。

通常SRPM的文件名后缀是`***.src.rpm`。不过，既然SRPM提供的是源代码，那为什么我们不使用Tarball直接安装就好了？ 这是因为 SRPM 虽然内容是源代码，但是他仍然含有该软件所需要的依赖软件说明、以及所有RPM 文件所提供的信息。同时，他与RPM 不同的是，他也提供了参数配置文件（就是 configure 和 makefile）。所以，如果我们下载的是SRPM，那么安装软件时，就必须要：

1. 先将该软件以 RPM 管理的方式编译，此时 SRPM 会被编译成 RPM 文件
2. 然后将编译完的 RPM 文件安装到Linux 系统中

<u>**SRPM 既然是源代码的格式，我们就可以通过修改 SRPM 内参数的配置文件，然后重新编译生成适合我们Linux 环境的RPM 文件。如此一来，就可以将该软件安装到我们的系统当中，而不必和原作者打包的Linux 环境想通了。这就是RPM 的用处。**</u>

| 文件格式 | 文件名格式  | 直接安装与否 |  内含程序类型  | 可否修改参数并编译 |
| :------: | :---------: | :----------: | :------------: | :----------------: |
|   RPM    |   xxx.rpm   |      可      |     已编译     |        不可        |
|   SRPM   | xxx.src.rpm |     不可     | 未编译的源代码 |         可         |

> 为什么说 CentOS 是社区维护的企业版：Red Hat 公司的RHEL 放出后，连带会将 SRPM 放出。社区的朋友就将这些SRPM 收集起来并重新编译成为所需要的软件，再重复放出成为 CentOS，所以才能号称和 Red Hat 的 RHEL 企业版同步。如果你想要了解 CentOS 是如何编译一个程序的，也能通过学习 SRPM 内含的编译参数来学习。

### 什么是i386,i586, i686, noarch, x86_64

我们知道 RPM 和 SRPM 的格式分别为：

xxx.rpm ：已经经过编译且包装完成的 rpm 文件

xxx.src.rpm： SRPM格式，包含未编译的源代码信息

我们可以通过文件名知道这个软件的版本、适用平台、编译放出的次数。例如 `rp-pppoe-3.11.5.e17.x86_64.rpm`的意义为：

```shell
rp-pppoe -     3.11  -    5     .el7.x86_64    .rpm
软件名称	软件的版本信息 放出的次数  适合的硬件平台	文件名后缀
```

除了后面适合的硬件平台和文件名后缀外，主要以 -  来隔开各个部分，这样子可以很清楚的发现该软件的名称、版本信息、打包次数和操作的硬件平台。

* 软件名称

* 版本信息

	分为主版本跟次版本

* 放出版本次数

	通常就是编译的次数。由于同一版的软件中，可能由于有某些bug或者是安全上的考虑，所以必须要进行小范围的path或重设一些编译参数。设置完成后重新编译并打包成 RPM 文件，因此就有不同的打包数出现。

* 操作硬件平台

	我们可以针对比较高级的CPU来进行最佳参数的配置，这样才能使用高级CPU所带来的硬件加速功能。所以就有所谓的各种文件名出现

	| 平台名称 | 适合平台说明                                                 |
	| :------: | ------------------------------------------------------------ |
	|   i386   |                                                              |
	|   i586   |                                                              |
	|   i686   |                                                              |
	|  x86_64  | 针对64位的CPU进行最佳编译设置，包括Intel的Core 2 以上等级CPU，以及对AMD的Athlon64 以后等级的CPU，都属于这一类型的硬件平台 |
	|  noarch  | 就是没有任何硬件等级上的限制。一般来说，这种类型的RPM文件，里面应该没有binary program 存在，较常出现的就是属于 shell script 方面的软件。 |

硬件方面都是向下兼容的。因此最低等级的i386软件可以安装在所有的 x86硬件平台上。

### RPM 的优点

由于RPM是通过预先编译并打包成为RPM文件格式后，再加以安装的一种方式，并且还能够进行数据库的记录。所以RPM 有以下优点：

* RPM 内含有已经编译过的程序和配置文件等信息，可以让使用者免除重新编译的困扰
* RPM 在被安装之前，会先检查系统的硬盘容量、操作系统版本等，可避免文件被错误安装
* RPM 文件本身提供软件版本信息、依赖属性软件名称、软件用途说明、软件所含文件等信息，便于了解软件
* RPM 管理的方式使用数据库记录 RPM 文件的相关参数，便于升级、移除、查询和验证

### RPM 属性依赖的克服方式： YUM 线上升级

CentOS

1. 先将放出的软件放到YUM服务器内
2. 然后分析这些软件的依赖属性问题，然后将软件内的记录信息写下来（header）。然后再将这些信息分析后记录成软件依赖的清单列表。这些列表信息和软件所在的本机或网络位置可以成为容易或软件仓库。当用户端有软件安装的需求时，用户端主机会主动向网上的yum 服务器的软件库网址下载清单列表，然后通过清单列表的数据和本机RPM 数据库已存在的软件信息比较，就能一口气安装所有需要的具有依赖属性的软件了。

> 所以软件仓库内的清单会记载每个文件的依赖属性关系，以及所有文件的网络位置，由于记录了详细的软件网络位置，所以有需要的时候，就会自动从网络下载该软件

当用户端有升级、安装的需求时，yum会向软件库要求清单的更新，等到清单更新包本机的/var/cache/yum 里面后，等一下更新时就会用这个本机清单和本机的 RPM 数据库进行比较，这样就知道该下载什么软件。接下来yum会到软件服务器（yum server）下载所需要的软件（因为有记录软件所在的网址），然后再通过RPM的机制开始安装软件。

> 为什么要做出“软件库”？
>
> ​        因为yum 服务器提供的 RPM 文件内容可能有所差异，举例来说，原厂放出的信息有： 原厂信息，更新信息，特殊信息（例如第三方软件，或某些特殊功能的软件）。这些软件文件基本不会放到一起，就用软件库的概念来处理，不同软件库网址，可以放不同的功能的软件

## RPM 软件管理程序： rpm

### RPM 默认安装的路径



### RPM 安装



### RPM 升级与更新



### RPM 查询



### RPM 验证和数字签名



### RPM 反安装和重建数据库



## YUM 线上升级机制

### 利用yum进行查询、安装、升级和删除功能



### yum的配置文件



### yum的软件群组功能



### EPEL/ELRepo 外挂软件以及自定义文件



### 全系统自动升级



### 管理的选择：RPM 还是Tarball



### 基础服务管理：以Apache 为例



SRPM 的使用：rpmbuild











